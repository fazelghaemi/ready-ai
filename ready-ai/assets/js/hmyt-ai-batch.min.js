jQuery(document).ready(function(t){let a=t("#hmyt-batch-job-type"),e=t("#hmyt-batch-target-type"),s=t("#hmyt-batch-category-wrapper"),o=t("#hmyt-batch-category-select"),n=t("#hmyt-item-count-info");function c(){let e=a.val(),s=[];s=e.includes("product")?window.hmytProductCategories||[]:window.hmytPostCategories||[],o.empty(),s.length>0&&t.each(s,function(a,e){o.append(t("<option>",{value:e.term_id,text:e.name}))}),o.trigger("change.select2")}function i(){n.html('<span class="spinner is-active" style="float: right;"></span>'),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_get_item_count",nonce:hmytBatchVars.nonce,job_type:a.val(),target_type:e.val(),category_id:"category"===e.val()?o.val():0},success:function(a){let e=t("#hmyt-ai-start-batch-btn");a.success?(n.html(`تعداد موارد یافت شده برای پردازش: <strong>${a.data.count}</strong>`),a.data.count>0?e.prop("disabled",!1):e.prop("disabled",!0)):(n.html(`<span style="color:red;">${a.data.message||"خطا در شمارش"}</span>`),e.prop("disabled",!0))}})}function d(){t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_get_all_jobs",nonce:hmytBatchVars.nonce},success:function(a){let e=t("#hmyt-batch-jobs-container"),s=t("#hmyt-ai-stop-all-jobs-btn"),o=!1;e.empty(),a.success&&a.data.length>0?a.data.forEach(t=>{("running"===t.status||"queued"===t.status)&&(o=!0);let a=function t(a){var e;let s=a.total_items>0?a.processed_items/a.total_items*100:0,o="running"===a.status||"queued"===a.status,n="completed"===a.status||"stopped"===a.status,c=a.failed_items>0,i={queued:{text:"در صف",class:"queued"},running:{text:"در حال پردازش",class:"running"},stopped:{text:"متوقف شده",class:"stopped"},completed:{text:"تکمیل شده",class:"completed"}}[a.status]||{text:a.status,class:""},d=function t(a,e,s){if("category"===a){let o=e.includes("product")?window.hmytProductCategories:window.hmytPostCategories,n=o.find(t=>t.term_id==s);return`دسته: ${n?n.name:"نامشخص"}`}return"no_summary_only"===a?"فقط موارد بدون خلاصه":"retry"===a?"تلاش مجدد برای ناموفق‌ها":"تمام موارد"}(a.target,a.type,a.category);return`
            <div class="hmyt-batch-job-item" data-job-id="${a.id}">
                <div class="job-info">
                    <strong>${e=a.type,({product_reviews:"خلاصه دیدگاه محصولات",product_descriptions:"خلاصه توضیحات محصولات",post_reviews:"خلاصه دیدگاه مقالات",post_content:"خلاصه محتوای مقالات"})[e]||e}</strong>
                    <small>${d}</small>
                    <span class="hmyt-status-badge status-${i.class}">${i.text}</span>
                </div>
                <div class="job-progress">
                    <div class="hmyt-progress-bar-wrapper">
                        <div class="hmyt-progress-bar status-${i.class}" style="width: ${s.toFixed(2)}%;"></div>
                    </div>
                    <span class="hmyt-progress-text">${a.processed_items} از ${a.total_items} (${s.toFixed(0)}%)</span>
                </div>
                <div class="job-stats">
                    <span>ناموفق: <strong class="hmyt-failed-count">${a.failed_items||0}</strong></span>
                    <span>تاریخ: ${new Date(1e3*a.start_time).toLocaleString("fa-IR")}</span>
                </div>
                <div class="job-actions">
                    <button type="button" class="button button-secondary hmyt-job-details-btn">جزئیات</button>
                    <button type="button" class="button button-secondary hmyt-retry-job-btn" ${n&&c?"":"disabled"}>تلاش مجدد</button>
                    <button type="button" class="button button-danger hmyt-stop-job-btn" ${o?"":"disabled"}>توقف</button>
                </div>
            </div>
        `}(t);e.append(a)}):e.html("<p>هیچ کاری برای نمایش وجود ندارد.</p>"),o?s.prop("disabled",!1):s.prop("disabled",!0)}})}e.on("change",function(){t("#hmyt-ai-start-batch-btn").prop("disabled",!0),"category"===t(this).val()?(c(),s.slideDown()):s.slideUp(),i()}),a.on("change",function(){t("#hmyt-ai-start-batch-btn").prop("disabled",!0),"category"===e.val()&&c(),i()}),o.on("change",i),o.select2({placeholder:"یک دسته بندی انتخاب کنید",width:"100%"}),t("#hmyt-copy-cron-command").on("click",function(){let a=t("#hmyt-cron-command-textarea");a.select(),document.execCommand("copy"),toast.success("دستور کران جاب کپی شد!")}),t("#hmyt-ai-start-batch-btn").on("click",function(){let s=t(this);s.prop("disabled",!0).text("در حال افزودن به صف..."),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_start_batch_job",nonce:hmytBatchVars.nonce,job_type:a.val(),target_type:e.val(),category_id:"category"===e.val()?o.val():0},success:function(t){t.success?(toast.success(t.data.message),d(),i()):toast.error(t.data.message||"خطا در شروع پردازش.")},error:function(){toast.error("خطای سرور در هنگام شروع پردازش.")},complete:function(){s.prop("disabled",!1).text("افزودن به صف پردازش")}})}),t(document).on("click",".hmyt-job-details-btn",function(){let a=t(this),e=a.closest(".hmyt-batch-job-item").data("job-id");0===t("#hmyt-batch-details-modal").length&&t("body").append(`
                <div id="hmyt-batch-details-modal" class="hmyt-admin-modal">
                    <div class="hmyt-admin-modal-content">
                        <span class="hmyt-admin-modal-close">&times;</span>
                        <h3>جزئیات پردازش</h3>
                        <div class="modal-body-content">...</div>
                    </div>
                </div>
            `);let s=t("#hmyt-batch-details-modal"),o=s.find(".modal-body-content");o.html('<span class="spinner is-active" style="float: right;"></span> در حال بارگذاری...'),s.show(),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_get_job_details",nonce:hmytBatchVars.nonce,job_id:e},success:function(t){if(t.success){let a='<table class="wp-list-table widefat fixed striped"><thead><tr><th>عنوان آیتم</th><th>وضعیت</th><th>پیام خطا</th></tr></thead><tbody>';t.data.length>0?t.data.forEach(function(t){let e="موفق"===t.status?"completed":"ناموفق"===t.status?"stopped":"queued";a+=`<tr>
                                <td><a href="${t.link}" target="_blank">${t.title} (ID: ${t.id})</a></td>
                                <td><span class="hmyt-status-badge status-${e}">${t.status}</span></td>
                                <td>${t.error||"---"}</td>
                            </tr>`}):a+='<tr><td colspan="3">موردی برای نمایش وجود ندارد.</td></tr>',a+="</tbody></table>",o.html(a)}else o.html(`<p style="color:red;">${t.data.message||"خطا در دریافت جزئیات."}</p>`)},error:function(){o.html('<p style="color:red;">خطای سرور در دریافت جزئیات.</p>')}})}),t(document).on("click","#hmyt-batch-details-modal .hmyt-admin-modal-close",function(){t("#hmyt-batch-details-modal").hide()}),t(document).on("click",function(a){t(a.target).is("#hmyt-batch-details-modal")&&t("#hmyt-batch-details-modal").hide()}),t(document).on("click",".hmyt-stop-job-btn",function(){let a=t(this),e=a.closest(".hmyt-batch-job-item").data("job-id");confirm("آیا از توقف این پردازش مطمئن هستید؟ آیتم های باقیمانده به عنوان ناموفق ثبت خواهند شد.")&&(a.prop("disabled",!0).text("در حال توقف..."),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_stop_batch_job",nonce:hmytBatchVars.nonce,job_id:e},success:function(t){t.success?(toast.success(t.data.message),d()):(toast.error(t.data.message||"خطا در توقف پردازش."),a.prop("disabled",!1).text("توقف"))},error:function(){toast.error("خطای سرور در هنگام توقف پردازش.")}}))}),t(document).on("click",".hmyt-retry-job-btn",function(){let a=t(this),e=a.closest(".hmyt-batch-job-item").data("job-id");a.prop("disabled",!0).text("در حال ایجاد..."),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_retry_failed_job",nonce:hmytBatchVars.nonce,job_id:e},success:function(t){t.success?(toast.success(t.data.message),d()):toast.error(t.data.message||"خطا در ایجاد کار جدید.")},error:function(){toast.error("خطای سرور در هنگام تلاش مجدد.")},complete:function(){a.prop("disabled",!1).text("تلاش مجدد")}})}),t(document).on("click","#hmyt-ai-stop-all-jobs-btn",function(){let a=t(this);confirm("آیا مطمئن هستید؟ تمام کارهای در حال پردازش متوقف خواهند شد.")&&(a.prop("disabled",!0).text("در حال توقف..."),t.ajax({url:hmytBatchVars.ajax_url,type:"POST",data:{action:"hmyt_ai_stop_all_active_jobs",nonce:hmytBatchVars.nonce},success:function(t){t.success?(toast.success(t.data.message),d()):toast.error(t.data.message||"خطا در توقف کارها.")},error:function(){toast.error("خطای سرور در هنگام توقف کارها.")},complete:function(){a.text("توقف همه کارها")}}))}),setInterval(d,7e3),d(),i()});