jQuery(document).ready(function(e){"undefined"!=typeof marked&&marked.setOptions({breaks:!0});let t=e("#hmyt-chatbot-fab"),s=e("#hmyt-chatbot-window"),a=e("#hmyt-chat-form"),o="fullscreen_shortcode"===hmytChatbot.display_mode,n=e("#hmyt-chat-messages"),i=e("#hmyt-user-message-input");i.height(),i.on("input",function(){this.style.height="auto";let e=this.scrollHeight;e>120?this.style.overflowY="auto":this.style.overflowY="hidden",this.style.height=Math.min(e,120)+"px"}),i.on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a.trigger("submit"))}),i.on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a.trigger("submit"))});let r=e("#hmyt-send-button"),l=e("#hmyt-typing-indicator"),d=e("#hmyt-new-chat-btn"),c=e(".hmyt-chatbot-login-required"),u=e("#hmyt-close-chat-btn"),p=e(".hmyt-chatbot-login-btn"),h=e("#hmyt-chatbot-suggestions"),m=e("#hmyt-voice-input-btn"),g=[],f=!0,$=null,_=!1,y="hmyt_ai_chat_history";function b(){try{localStorage.setItem(y,JSON.stringify(g))}catch(e){console.error("Error saving chat history:",e)}}let v="all_users"===hmytChatbot.access_restriction||hmytChatbot.is_user_logged_in;function w(a=!1){s.hasClass("open")||((_=a)&&e("#hmyt-chatbot-widget").show(),e("#hmyt-chatbot-widget").addClass("open"),s.addClass("open"),t.addClass("hidden"),history.pushState({chatbotOpen:!0},"","#hmyt-chat"),v&&(e(window).width()>768&&i.focus(),f&&0===g.length&&(x("model",hmytChatbot.welcome_message,!0),f=!1)),setTimeout(function(){C()},350))}function k(a=!1){s.hasClass("open")&&(e("#hmyt-chatbot-widget").removeClass("open"),s.removeClass("open"),hmytChatbot.is_integrated_with_contact_widget?setTimeout(function(){e("#hmyt-chatbot-widget").hide()},300):t.removeClass("hidden"),a||"#hmyt-chat"!==location.hash||history.back(),_&&(e(document).trigger("hmyt:chatbot-closed"),_=!1))}function C(){setTimeout(()=>{if(!n.length||!n[0])return;let e=n.find(".message-wrapper:last-child");e.length?e[0].scrollIntoView({behavior:"smooth",block:"end"}):n.scrollTop(n[0].scrollHeight)},100)}function x(t,s,a=!1,o=null,i=null,r=null,l=null,d="none",c=!1,u={}){e(".regenerate-btn").remove();let p=o||new Date().toISOString().slice(0,19),h=o?new Date(o+"Z").toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"}):new Date().toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"}),m=e("<div>").addClass(`message-wrapper ${t}`),f=e("<div>").addClass(`message ${t}`);f.html(marked.parse(s)),f.find("a").attr("target","_blank").attr("rel","noopener noreferrer");let $=e("<div>").addClass("message-footer"),_=!1;if(hmytChatbot.bot_avatar_url||hmytChatbot.user_avatar_url){let y=e("<div>").addClass("avatar-container"),v=!1;"user"===t&&hmytChatbot.user_avatar_url?(y.html(`<img src="${hmytChatbot.user_avatar_url}" alt="User Avatar">`),v=!0):"model"===t&&hmytChatbot.bot_avatar_url&&(y.html(`
                    <svg class="check" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 85.333c-234.667 0-426.667 192-426.667 426.667s192 426.667 426.667 426.667 426.667-192 426.667-426.667S746.667 85.333 512 85.333m-85.333 640L213.333 512l60.16-60.16 153.174 152.747 323.84-323.84 60.16 60.586-384 384z" fill="currentColor"></path></svg>
                    <img src="${hmytChatbot.bot_avatar_url}" alt="Bot Avatar">
                `),v=!0),v&&($.append(y),_=!0)}if(_&&$.addClass("has-avatar"),"user"===t)$.append(`<div class="sender-name">شما</div><div class="timestamp">${h}</div>`);else{let w=e("<div>").addClass("message-actions");if(!1!==u.showActions&&!a){let k=e(`<button class="copy-to-clipboard-btn" title="کپی کردن متن">${hmytChatbot.icons.copy}</button>`),x=null;!1!==u.showRegenerateButton&&(x=e(`<button class="regenerate-btn" title="تولید مجدد پاسخ">${hmytChatbot.icons.regenerate}</button>`));let j=e(`<button class="hmyt-feedback-btn like" data-feedback="like" title="بازخورد مثبت">${hmytChatbot.icons.like}</button>`),I=e(`<button class="hmyt-feedback-btn dislike" data-feedback="dislike" title="بازخورد منفی">${hmytChatbot.icons.dislike}</button>`);w.append(k).append(j).append(I),x&&w.append(x),("like"===d||"dislike"===d)&&(j.prop("disabled",!0),I.prop("disabled",!0),"like"===d?j.addClass("active"):I.addClass("active"))}$.append(`<div class="sender-name">${hmytChatbot.bot_name}</div><div class="timestamp">${h}</div>`).append(w)}if(m.append(f),n.find("#hmyt-typing-indicator").before(m),i&&i.length>0?function t(s,a,o){let n=e('<div class="hmyt-product-recommendations-loading"><div class="typing-indicator" style="display:flex;"><span></span><span></span><span></span></div></div>');a.append(n),C(),e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_get_product_boxes",nonce:hmytChatbot.nonce,product_ids:s},success:function(e){n.remove(),e.success&&a.append(e.data.html)},error:function(){n.remove()},complete:function(){a.append(o),C()}})}(i,m,$):r&&r.length>0?function t(s,a,o){let n=e('<div class="hmyt-product-recommendations-loading"><div class="typing-indicator" style="display:flex;"><span></span><span></span><span></span></div></div>');a.append(n),C(),e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_get_category_boxes",nonce:hmytChatbot.nonce,category_ids:s},success:function(e){e.success&&a.append(e.data.html)},error:function(){console.log("Failed to load categories.")},complete:function(){n.remove(),a.append(o),C()}})}(r,m,$):m.append($),a||c)l&&m.attr("data-message-id",l);else{let S=l||`msg_${new Date().getTime()}_${Math.random()}`;m.attr("data-message-id",S);let T={role:t,parts:[{text:s}],timestamp:p,message_id:S,options:u};"model"===t&&(T.feedback=d),i&&(T.product_ids=i),r&&(T.category_ids=r),g.push(T),b()}C()}function j(t){v&&t&&(f=!1,x("user",t),i.val("").prop("disabled",!0).trigger("input"),r.prop("disabled",!0),l.show(),C(),e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_chatbot_message",nonce:hmytChatbot.nonce,message:t,history:JSON.stringify(g.slice(0,-1)),post_id:hmytChatbot.post_id||null,session_id:$,page_url:window.location.href},success:function(e){if(e.success){let t=g[g.length-1];t&&"user"===t.role&&e.data.user_message_id&&(t.message_id=e.data.user_message_id,t.timestamp=e.data.timestamp_utc,n.find(".message-wrapper.user:last").attr("data-message-id",e.data.user_message_id),b()),x("model",e.data.reply,!1,e.data.timestamp_utc,e.data.product_ids||null,e.data.category_ids||null,e.data.message_id||null),e.data.session_id&&($=e.data.session_id,localStorage.setItem("hmyt_ai_chat_session_id",$))}else"limit_exceeded"===e.data.code?(x("model",e.data.message),i.prop("disabled",!0),r.prop("disabled",!0)):x("model","متاسفانه خطایی رخ داد. لطفاً کمی بعد مجدداً تلاش کنید.")},error:function(){x("model","متاسفانه خطایی در ارتباط رخ داد. لطفاً اتصال اینترنت خود را بررسی کرده و مجدداً تلاش کنید.")},complete:function(){l.hide(),i.prop("disabled",!1),r.prop("disabled",!1),e(window).width()>768&&i.focus()}}))}function I(){let t=hmytChatbot.quick_suggestions&&hmytChatbot.quick_suggestions.length>0,s=hmytChatbot.enable_order_tracking;if(t||s){if(h.empty().show(),s){let a=e("<button>").addClass("hmyt-suggestion-btn hmyt-order-tracking-btn").text("پیگیری سریع سفارش");a.on("click",R),h.prepend(a)}t&&hmytChatbot.quick_suggestions.forEach(t=>{let s=e("<button>").addClass("hmyt-suggestion-btn").text(t.title);s.on("click",function(){let e=t.title,s=t.answer;x("user",e),setTimeout(function(){x("model",s,!1,null,null,null,null,"none",!1,{showRegenerateButton:!1}),H()},500)}),h.append(s)})}else h.hide()}if(!v&&(c.show(),i.prop("disabled",!0).attr("placeholder","برای چت کردن وارد شوید..."),r.prop("disabled",!0),hmytChatbot.show_login_button&&p.attr("href",hmytChatbot.login_url).show()),o||(t.on("click",w),u.on("click",function(){k(!1)}),e(window).on("popstate",function(e){"#hmyt-chat"!==location.hash&&s.hasClass("open")&&k(!0)})),d.on("click",function(e){e.preventDefault(),g=[],localStorage.removeItem(y),localStorage.removeItem("hmyt_ai_chat_session_id"),$=null,n.find(".message-wrapper").remove(),n.find(".hmyt-chatbot-order-list").remove(),x("model",hmytChatbot.welcome_message,!0),v&&(i.focus(),I())}),n.on("click",".copy-to-clipboard-btn",function(){let t=e(this),s=t.closest(".message-wrapper").find(".message").text();navigator.clipboard.writeText(s).then(()=>{toast.success("متن با موفقیت کپی شد!");let e=t.html(),s=`
                <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.31 14.7L10.81 16.2L14.81 12.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M10 6H14C16 6 16 5 16 4C16 2 15 2 14 2H10C9 2 8 2 8 4C8 6 9 6 10 6Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16 4.02002C19.33 4.20002 21 5.43002 21 10V16C21 20 20 22 15 22H9C4 22 3 20 3 16V10C3 5.44002 4.67 4.20002 8 4.02002" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;t.html(s),setTimeout(()=>{t.html(e)},2e3)}).catch(e=>{toast.error("خطا در کپی کردن متن."),console.error("Copy failed: ",e)})}),n.on("click",".regenerate-btn",function(){if(g.length<2)return;let e=g[g.length-2];if("user"!==e.role)return;let t=e.parts[0].text;g.pop(),g.pop(),b(),n.find(".message-wrapper").slice(-2).remove(),j(t)}),a.on("submit",function(e){e.preventDefault();let t=i.val().trim();j(t)}),v&&I(),!function e(){let t=localStorage.getItem(y);if(t)try{let s=!1;g=JSON.parse(t),n.find(".message-wrapper, .hmyt-product-recommendations, .hmyt-category-recommendations, .hmyt-chatbot-order-list").remove(),g.forEach(e=>{e.message_id||(e.message_id=`msg_${new Date().getTime()}_${Math.random()}`,s=!0)}),s&&b();let a=localStorage.getItem("hmyt_ai_chat_session_id");a&&($=a),g.forEach(e=>{x(e.role,e.parts[0].text,!1,e.timestamp,e.product_ids||null,e.category_ids||null,e.message_id,e.feedback||"none",!0,e.options||{})}),g.length>0&&(f=!1)}catch(o){console.error("Error parsing chat history:",o),localStorage.removeItem(y),g=[]}}(),o&&v&&f&&0===g.length&&(x("model",hmytChatbot.welcome_message,!0),f=!1),hmytChatbot.placeholder_text&&i.attr("placeholder",hmytChatbot.placeholder_text),h.length){let S=!1,T,O;h.on("mousedown",e=>{S=!0,h.addClass("active-drag"),h.css("cursor","grabbing"),T=e.pageX-h.offset().left,O=h.scrollLeft()}),h.on("mouseleave mouseup",()=>{S=!1,h.removeClass("active-drag"),h.css("cursor","grab")}),h.on("mousemove",e=>{if(!S)return;e.preventDefault();let t=e.pageX-h.offset().left,s=(t-T)*2;h.scrollLeft(O-s)})}function R(){if(x("user","میخواهم سفارشم را پیگیری کنم."),!hmytChatbot.is_user_logged_in){setTimeout(()=>{x("model","برای پیگیری سریع سفارش، لطفاً ابتدا وارد حساب کاربری خود شوید.",!1,null,null,null,null,"none",!1,{showRegenerateButton:!1}),H()},500);return}l.show(),C(),e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_get_user_orders",nonce:hmytChatbot.nonce},success:function(t){t.success?t.data.orders&&t.data.orders.length>0?(x("model","عالی! لطفاً یکی از ۳ سفارش اخیر خود را برای مشاهده جزئیات انتخاب کنید:",!1,null,null,null,null,"none",!1,{showActions:!1}),function t(s){let a=e("<div>").addClass("hmyt-chatbot-order-list");s.forEach(e=>{let t=`
                <div class="hmyt-chatbot-order-item" data-order-id="${e.id}">
                    <div class="order-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.39999 6.5H15.6C19 6.5 19.34 8.09 19.57 10.03L20.47 17.53C20.76 19.99 20 22 16.5 22H7.50999C3.99999 22 3.23999 19.99 3.53999 17.53L4.44 10.03C4.66 8.09 4.99999 6.5 8.39999 6.5Z" stroke="#54667a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 8V4.5C8 3 9 2 10.5 2H13.5C15 2 16 3 16 4.5V8" stroke="#54667a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="order-details-wrapper">
                        <div class="order-id-status">
                            <span class="order-id">${e.order_number}</span>
                            <span class="order-status-badge">${e.status}</span>
                        </div>
                        <div class="order-meta">
                            <span>${e.date}</span>
                            <span>${e.total}</span>
                        </div>
                    </div>
                </div>
            `;a.append(t)}),n.find("#hmyt-typing-indicator").before(a),C(),a.on("click",".hmyt-chatbot-order-item",function(t){var s;t.stopPropagation();let o=e(this).data("order-id"),n=e(this).find(".order-id").text();a.remove(),x("user",`لطفاً جزئیات سفارش ${n} را نمایش بده.`),l.show(),C(),s=o,e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_get_order_details_for_ai",nonce:hmytChatbot.nonce,order_id:s,session_id:$,history:JSON.stringify(g.slice(0,-1)),page_url:window.location.href},success:function(e){e.success?(x("model",e.data.reply,!1,e.data.timestamp_utc,null,null,e.data.message_id,"none",!1,{showRegenerateButton:!1}),e.data.session_id&&($=e.data.session_id,localStorage.setItem("hmyt_ai_chat_session_id",$))):x("model","متاسفانه خطایی رخ داد. لطفاً کمی بعد مجدداً تلاش کنید.")},error:function(){x("model","متاسفانه خطایی در ارتباط رخ داد. لطفاً اتصال اینترنت خود را بررسی کرده و مجدداً تلاش کنید.")},complete:function(){l.hide(),C()}})})}(t.data.orders)):x("model","متاسفانه سفارش فعالی در حساب کاربری شما یافت نشد."):x("model","متاسفانه خطایی رخ داد. لطفاً کمی بعد مجدداً تلاش کنید.")},error:function(){x("model","متاسفانه خطایی در ارتباط رخ داد. لطفاً اتصال اینترنت خود را بررسی کرده و مجدداً تلاش کنید.")},complete:function(){l.hide(),C()}})}function H(){e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_log_interaction",nonce:hmytChatbot.nonce,session_id:$,history:JSON.stringify(g),page_url:window.location.href},success:function(e){e.success&&e.data.session_id&&($=e.data.session_id,localStorage.setItem("hmyt_ai_chat_session_id",$))},error:function(){console.error("Failed to log client-side interaction.")}})}if(hmytChatbot.enable_voice_input){let L=window.SpeechRecognition||window.webkitSpeechRecognition;if(L){let P=new L;P.continuous=!1,P.lang="fa-IR",P.interimResults=!0;let B=!1;m.show(),m.on("click",()=>{B?P.stop():P.start()}),P.onstart=()=>{B=!0,m.addClass("is-recording"),i.attr("placeholder","در حال شنیدن...")},P.onend=()=>{B=!1,m.removeClass("is-recording"),i.attr("placeholder",hmytChatbot.placeholder_text||"پیام خود را بنویسید...")},P.onerror=e=>{let t="خطایی در تشخیص گفتار رخ داد.";"no-speech"===e.error?t="صدایی تشخیص داده نشد. لطفاً دوباره تلاش کنید.":"audio-capture"===e.error?t="خطا در دسترسی به میکروفون. مطمئن شوید میکروفون متصل است.":"not-allowed"===e.error&&(t="دسترسی به میکروفون مسدود شده است. لطفاً از تنظیمات مرورگر دسترسی را فعال کنید."),toast.error(t)},P.onresult=e=>{let t="",s="";for(let a=e.resultIndex;a<e.results.length;++a)e.results[a].isFinal?s+=e.results[a][0].transcript:t+=e.results[a][0].transcript;i.val(s||t).trigger("input")}}else console.log("HMYT AI: Web Speech API is not supported in this browser.")}n.on("click",".hmyt-feedback-btn",function(){let t=e(this),s=t.closest(".message-wrapper"),a=s.data("message-id"),o=t.data("feedback");!(t.hasClass("active")||t.prop("disabled"))&&(s.find(".hmyt-feedback-btn").prop("disabled",!0),t.addClass("active").prop("disabled",!1),e.ajax({url:hmytChatbot.ajax_url,type:"POST",data:{action:"hmyt_ai_chatbot_message_feedback",nonce:hmytChatbot.nonce,session_id:$,message_id:a,feedback:o},success:function(e){if(e.success){toast.success("بازخورد شما ثبت شد.");let n=g.findIndex(e=>e.message_id===a);n>-1&&(g[n].feedback=o,b())}else toast.error(e.data.message||"خطا در ثبت بازخورد."),s.find(".hmyt-feedback-btn").prop("disabled",!1),t.removeClass("active")},error:function(){toast.error("خطای ارتباط با سرور."),s.find(".hmyt-feedback-btn").prop("disabled",!1),t.removeClass("active")}}))}),e(document).on("hmyt:open-chatbot",function(){w(!0)}),hmytChatbot.is_integrated_with_contact_widget&&e("#hmyt-chatbot-widget").hide()});