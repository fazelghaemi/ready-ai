// developed by web-premium.ir
jQuery(document).ready(function(e){function t(e){let t=e.toString().replace(/[^0-9.]/g,"");if(!t)return"";let n=t.split("."),a=n[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),i=n[1]?"."+n[1].slice(0,2):"";return a+i}e(document).on("input",".hmyt-number-input",function(e){let n=this.value.replace(/[^0-9.]/g,"");n?this.value=t(n):this.value="";let a=e.target.selectionStart,i=(this.value.substring(0,a).match(/,/g)||[]).length,d=(t(n).substring(0,a).match(/,/g)||[]).length,s=a+(d-i);this.setSelectionRange(s,s)}),document.querySelectorAll(".hmyt-numbers").forEach(e=>{let n=e.textContent,a=n.replace(/[^0-9.]/g,"");a&&(e.textContent=t(a)+(n.includes(hmyt_affiliate_vars.currency_symbol)?" "+hmyt_affiliate_vars.currency_symbol:n.includes("٪")?"٪":""))});let n=`
    <div id="hmyt-admin-bank-modal" class="hmyt-admin-modal">
        <div class="hmyt-admin-modal-content">
            <span class="hmyt-admin-modal-close">\xd7</span>
            <h3>اطلاعات بانکی کاربر</h3>
            <div id="hmyt-admin-user-info" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; font-family: 'Estedad-FD', sans-serif;">
                <div><strong>نام نمایشی:</strong> <span id="hmyt-admin-user-displayname"></span></div>
                <div><strong>نام کاربری:</strong> <span id="hmyt-admin-user-username"></span></div>
                <div><strong>موجودی فعلی:</strong> <span id="hmyt-admin-user-balance" class="hmyt-numbers"></span> </div>
            </div>
            
            <div id="hmyt-admin-bank-info-display" style="margin-top:10px; padding: 10px; background: #f9fafb; border-radius: 8px; font-family: 'Estedad-FD', sans-serif;">
                <div><strong>نام و نام خانوادگی:</strong> <span id="hmyt-admin-bank-name-display"></span></div>
                <div><strong>شماره کارت:</strong> <span id="hmyt-admin-bank-card-display"></span></div>
                <div><strong>شماره شبا:</strong> <span id="hmyt-admin-bank-sheba-display"></span></div>
                <div><strong>نام بانک:</strong> <span id="hmyt-admin-bank-bank-display"></span></div>
            </div>
            <p style="margin-top: 15px; font-size: 13px; color: #6c757d; font-family: 'Estedad-FD', sans-serif;">
                این اطلاعات را ادمین می&zwnj;تواند در 
                <a id="hmyt-admin-bank-profile-link" href="#" target="_blank" style="color: #0073aa; text-decoration: underline; font-weight: bold;">صفحه پروفایل شناسنامه وردپرس کاربر</a> 
                ادیت یا ایجاد کند.
            </p>
            <div id="hmyt-admin-bank-message"></div>
        </div>
    </div>
    `,a=document.getElementById("hmyt-admin-bank-modal"),i=document.getElementById("hmyt-create-modal"),d=document.getElementById("hmyt-open-create-modal");e(document).on("click",".hmyt-open-bank-info",function(){let i=this.dataset.userId,d=this.dataset.editUserLink;a||(e("body").append(n),e(a=document.getElementById("hmyt-admin-bank-modal")).on("click",".hmyt-admin-modal-close",function(){e(a).hide()}),e(window).on("click",function(t){a&&t.target===a&&e(a).hide()}));let s=e("#hmyt-admin-bank-message");s.length&&s.html("");let r=toast.loading("در حال بارگذاری اطلاعات بانکی...");fetch(hmyt_affiliate_vars.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`action=hmyt_get_user_info&user_id=${i}&_wpnonce=${hmyt_affiliate_vars.nonce_get_user_info}`}).then(e=>e.json()).then(n=>{toast.closeLoading(r),n.success?(e("#hmyt-admin-user-displayname").text(n.data.user.display_name),e("#hmyt-admin-user-username").text(n.data.user.user_login),e("#hmyt-admin-user-balance").text(t(n.data.balance.toString())+" "+hmyt_affiliate_vars.currency_symbol),e("#hmyt-admin-bank-name-display").text(n.data.bank_info?.name||"---"),e("#hmyt-admin-bank-card-display").text(n.data.bank_info?.card||"---"),e("#hmyt-admin-bank-sheba-display").text(n.data.bank_info?.sheba?n.data.bank_info.sheba:"---"),e("#hmyt-admin-bank-bank-display").text(n.data.bank_info?.bank||"---"),e("#hmyt-admin-bank-profile-link").attr("href",d),e(a).show(),e(a).find(".hmyt-admin-modal-content").css("animation","zoomIn 0.3s ease-out")):toast.error(n.data?.message||"خطا در دریافت اطلاعات کاربر.")}).catch(e=>{toast.closeLoading(r),console.error("Error:",e),toast.error("خطا در ارتباط با سرور.")})}),d&&d.addEventListener("click",()=>{i.style.display="block",i.querySelector(".hmyt-admin-modal-content").style.animation="zoomIn 0.3s ease-out",document.getElementById("hmyt-create-user-select")&&e("#hmyt-create-user-select").val(null).trigger("change"),document.getElementById("hmyt-create-user-balance").innerHTML="",document.getElementById("hmyt-create-user-bank-info").innerHTML="",document.getElementById("hmyt-create-settle-amount").value="",document.getElementById("hmyt-create-message").innerHTML=""}),document.querySelectorAll(".hmyt-admin-modal-close").forEach(t=>{t.addEventListener("click",()=>{a&&e(a).hide(),i&&e(i).hide()})}),window.addEventListener("click",t=>{a&&t.target===a&&e(a).hide(),i&&t.target===i&&e(i).hide()}),e(document).on("blur",'input[name="bank_card"]',function(){let t=e(this).val().replace(/ /g,"");16!==t.length&&0!==t.length&&(toast.error("شماره کارت باید 16 رقم باشد."),e(this).focus())}),document.getElementById("hmyt-create-form")?.addEventListener("submit",function(e){e.preventDefault();let t=this.querySelector('button[type="submit"]');t.disabled=!0,t.textContent="در حال ثبت...";let n=new FormData(this),a=this.querySelector('input[name="settle_amount"]'),d=a.value.replace(/,/g,"");n.set("settle_amount",d);let s=document.getElementById("hmyt-create-message");s.innerHTML="",fetch(hmyt_affiliate_vars.ajaxurl,{method:"POST",body:n}).then(e=>e.json()).then(e=>{e.success?(toast.success(e.data?.message||"درخواست با موفقیت ثبت شد."),setTimeout(()=>{i.style.display="none",s.innerHTML="",location.reload()},1500)):toast.error("خطا: "+(e.data?.message||"خطای ناشناخته")),t.disabled=!1,t.textContent="ثبت درخواست"}).catch(e=>{toast.error("خطا در ارتباط با سرور: "+e.message),t.disabled=!1,t.textContent="ثبت درخواست"})})});