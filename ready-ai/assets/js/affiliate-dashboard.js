jQuery(document).ready(function(e){let t=hmyt_affiliate_dashboard_vars;e(".hmyt-skeleton-wrapper").length&&!e(".hmyt-dashboard-wrapper").is(":visible")?setTimeout(()=>{e(".hmyt-skeleton-wrapper").find(".hmyt-skeleton-tab, .hmyt-skeleton-content").hide(),e(".hmyt-dashboard-wrapper").removeClass("hidden")},2e3):e(".hmyt-dashboard-wrapper").removeClass("hidden");let a=window.location.hash.substring(1);if(a){let n=document.querySelector(`.hmyt-tab[data-tab="${a}"]`);if(n){document.querySelectorAll(".hmyt-tab").forEach(e=>e.classList.remove("hmyt-tab-active")),document.querySelectorAll(".hmyt-tab-content").forEach(e=>e.classList.remove("hmyt-tab-content-active")),n.classList.add("hmyt-tab-active");let s=document.getElementById(a);s&&s.classList.add("hmyt-tab-content-active")}}function l(e){let t=e.toString().replace(/[^0-9.]/g,"");if(!t)return"";let a=t.split("."),n=parseInt(a[0]).toLocaleString("en-US",{useGrouping:!0}),s=a[1]?"."+a[1]:"";return n+s}document.querySelectorAll(".hmyt-number-input").forEach(e=>{if(e.addEventListener("input",function(e){this.value=this.value.replace(/[^0-9,]/g,"")}),e.addEventListener("blur",function(){let e=this.value.replace(/,/g,"");e&&(this.value=l(e))}),e.value){let t=e.value.replace(/,/g,"");e.value=t?l(t):""}}),document.querySelectorAll(".hmyt-numbers").forEach(e=>{let a=e.textContent,n=a.replace(/[^0-9.]/g,"");if(n){let s=l(n);e.textContent=s+(a.includes(t.currency_symbol)?" "+t.currency_symbol:a.includes("٪")?"٪":"")}}),document.querySelectorAll(".hmyt-tab").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".hmyt-tab").forEach(e=>e.classList.remove("hmyt-tab-active")),document.querySelectorAll(".hmyt-tab-content").forEach(e=>e.classList.remove("hmyt-tab-content-active")),this.classList.add("hmyt-tab-active"),document.getElementById(this.dataset.tab).classList.add("hmyt-tab-content-active"),history.replaceState(null,null,"#"+this.dataset.tab)})}),e(document).on("click",".hmyt-copy-button",function(){let a=e(this).siblings('input[type="text"]')[0];navigator.clipboard.writeText(a.value).then(()=>{toast.success(t.messages.link_copied)}).catch(e=>{toast.error(t.messages.copy_error),console.error("Failed to copy: ",e)})});let o=document.getElementById("hmyt-withdraw-modal"),r=document.getElementById("hmyt-wallet-modal"),c=document.getElementById("hmyt-open-withdraw-modal"),i=document.getElementById("hmyt-open-wallet-modal"),d=document.querySelectorAll(".hmyt-modal-close");function m(){let t=e('#hmyt_enable_telegram_notifications_switch input[name="enable_telegram_notifications"]'),a=e('#hmyt_enable_telegram_status_switch input[name="enable_telegram_status_notifications"]'),n=e("#telegram-token-wrapper");if(!n.length)return;let s=!!t.length&&"1"===t.val(),l=!!a.length&&"1"===a.val();s||l?n.slideDown():n.slideUp()}c&&c.addEventListener("click",()=>{let e=parseFloat(document.getElementById("current-balance-display").textContent.replace(/[^0-9.]/g,""));e>=t.min_settlement?(o.style.display="block",o.querySelector(".hmyt-modal-content").style.animation="zoomIn 0.3s ease-out"):toast.error("موجودی شما کمتر از حداقل مبلغ تسویه ("+l(t.min_settlement)+" "+t.currency_symbol+") است.")}),i&&i.addEventListener("click",()=>{let e=parseFloat(document.getElementById("current-balance-display").textContent.replace(/[^0-9.]/g,""));e>0?(r.style.display="block",r.querySelector(".hmyt-modal-content").style.animation="zoomIn 0.3s ease-out"):toast.error("موجودی شما برای انتقال کافی نیست.")}),d.forEach(e=>{e.addEventListener("click",()=>{o&&(o.style.display="none"),r&&(r.style.display="none")})}),window.addEventListener("click",e=>{e.target===o&&(o.style.display="none"),e.target===r&&(r.style.display="none")}),e("#hmyt-bank-form").on("submit",function(a){a.preventDefault();let n=this.querySelector('button[type="submit"]');n.disabled=!0,n.textContent="در حال ذخیره...";let s=new FormData(this);s.append("_ajax_nonce",t.nonce_bank_info);let l=e("#hmyt-bank-message");l.html(""),e.ajax({url:t.ajax_url,type:"POST",data:e(this).serialize()+"&action=hmyt_save_bank_info&hmyt_bank_nonce="+t.nonce_bank_info,success:function(e){e.success?toast.success("اطلاعات بانکی با موفقیت ذخیره شد."):toast.error("خطا: "+(e.data?.message||"خطای ناشناخته"))},error:function(e){toast.error("خطا در ارتباط با سرور: "+e.statusText)},complete:function(){n.disabled=!1,n.textContent="ذخیره اطلاعات بانکی"}})}),e("#hmyt-withdraw-form, #hmyt-wallet-form").on("submit",function(a){a.preventDefault();let n=e(this),s=n.find('button[type="submit"]');s.prop("disabled",!0).text("در حال ثبت درخواست...");let o=n.find('input[name="settle_amount"]'),r=o.val().replace(/,/g,"");if("hmyt-withdraw-form"===n.attr("id")&&parseFloat(r)<t.min_settlement){toast.error("مبلغ درخواستی برای تسویه بانکی نمی‌تواند کمتر از "+l(t.min_settlement)+" "+t.currency_symbol+" باشد."),s.prop("disabled",!1).text("ثبت درخواست");return}let c=n.serializeArray();c.find(e=>"settle_amount"===e.name).value=r,c.push({name:"hmyt_settlement_nonce",value:t.nonce_settlement}),e.ajax({url:t.ajax_url,type:"POST",data:e.param(c),success:function(a){if(a.success){toast.success(a.data?.message||"درخواست با موفقیت ثبت شد.");let s=a.data?.new_balance||0;e("#current-balance-display").text(l(s)),e("#amount").text(l(s)+" "+t.currency_symbol),e('#hmyt-withdraw-form input[name="settle_amount"]').val(l(s)),e('#hmyt-wallet-form input[name="settle_amount"]').val(l(s)),setTimeout(()=>{n.closest(".hmyt-modal").hide()},1500)}else toast.error("خطا: "+(a.data?.message||"خطای ناشناخته"))},error:function(){toast.error("خطا در ارتباط با سرور.")},complete:function(){s.prop("disabled",!1).text("ثبت درخواست")}})}),e(".hmyt-switch-toggle").on("click",".hmyt-switch-item",function(){let t=e(this),a=t.closest(".hmyt-switch-toggle"),n=a.find('input[type="hidden"]');n.val(t.data("value")),a.find(".hmyt-switch-item").removeClass("item-selected"),t.addClass("item-selected"),a.attr("id").includes("hmyt_enable_telegram")&&m()}),m(),e("#hmyt-telegram-form").on("submit",function(a){a.preventDefault();let n=e(this).find('button[type="submit"]');n.prop("disabled",!0).text("در حال ثبت..."),e.ajax({url:t.ajax_url,type:"POST",data:e(this).serialize()+"&action=hmyt_save_telegram_settings&hmyt_telegram_nonce="+t.nonce_telegram,success:function(e){e.success?toast.success("تنظیمات با موفقیت ذخیره شد."):toast.error("خطا: "+(e.data?.message||"خطای ناشناخته"))},error:function(){toast.error("خطا در ارتباط با سرور.")},complete:function(){n.prop("disabled",!1).text("ذخیره تنظیمات تلگرام")}})}),e(".hmyt-tab-link-js").on("click",function(t){t.preventDefault();let a=e(this).data("tab");e(`.hmyt-tab[data-tab="${a}"]`).trigger("click")}),e("#bank_bank_select").hasClass("hmyt-select2-advanced")&&e("#bank_bank_select").select2({placeholder:"انتخاب یا جستجوی بانک...",allowClear:!0,width:"100%",minimumResultsForSearch:0}),e("#bank_card").on("blur",function(){let a=e(this).val().replace(/\s/g,"");a.length>0&&16!==a.length&&toast.error(t.messages.invalid_card)}),e("#hmyt-coupon-creator-form").on("submit",function(a){a.preventDefault();let n=e(this),s=n.find('button[type="submit"]');s.prop("disabled",!0).text("در حال ساخت..."),e.ajax({url:t.ajax_url,type:"POST",data:{action:"hmyt_create_sharable_coupon_v3",nonce:t.nonce_create_coupon,coupon_code:e("#coupon_code").val(),discount_percent:e("#discount_percent").val(),minimum_amount:e("#minimum_amount").val().replace(/,/g,""),usage_limit:e("#usage_limit").val(),expiry_date:e("#expiry_date").val()},success:function(t){if(t.success){toast.success(t.data.message);let a=t.data.coupon,s=`<div class="panel-box-item coupon-list-item" id="coupon-item-${a.id}">
                            <div class="coupon-code-wrapper" title="برای کپی کلیک کنید" data-code="${a.code}"><span class="coupon-code">${a.code}</span></div>
                            <div class="coupon-details">
                                <span><strong>${a.amount}%</strong> تخفیف</span>
                                <span>استفاده شده: <strong>0</strong></span>
                                <span>تاریخ ساخت: <strong>${a.date_created}</strong></span>
                            </div>
                            <div><button class="coupon-delete-btn" data-coupon-id="${a.id}">حذف</button></div>
                        </div>`;e("#hmyt-user-coupons-list").prepend(s),n[0].reset()}else toast.error(t.data.message)},error:function(){toast.error("خطای سرور. لطفاً دوباره تلاش کنید.")},complete:function(){s.prop("disabled",!1).text("ساخت کد تخفیف")}})}),e(document).on("click",".coupon-code-wrapper",function(){let a=e(this).data("code");navigator.clipboard.writeText(a).then(()=>{toast.success(t.messages.coupon_code_copied.replace("{coupon_code}",a))})}),e(document).on("click",".coupon-delete-btn",function(){if(!confirm(t.messages.coupon_delete_confirm))return;let a=e(this),n=a.data("coupon-id");a.prop("disabled",!0).text("در حال حذف..."),e.ajax({url:t.ajax_url,type:"POST",data:{action:"hmyt_delete_sharable_coupon",nonce:t.nonce_delete_coupon,coupon_id:n},success:function(t){t.success?(toast.success(t.data.message),e(`#coupon-item-${n}`).fadeOut(300,function(){e(this).remove()})):(toast.error(t.data.message),a.prop("disabled",!1).text("حذف"))},error:function(){toast.error("خطای سرور هنگام حذف."),a.prop("disabled",!1).text("حذف")}})})});