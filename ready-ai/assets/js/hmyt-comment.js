document.addEventListener("DOMContentLoaded",function(){let e=document.getElementById("hamyar-comment-app");if(!e)return;let t=e.dataset.productId,l=document.getElementById("product-rate-tip"),r=document.getElementById("product-rate-tip-close"),a=document.getElementById("comment-list"),n=document.getElementById("comment-list-loader"),o=document.getElementById("load-more-container"),s=document.getElementById("load-more-btn"),c=document.querySelectorAll(".filter-btn"),i=document.getElementById("hamyar-comment-modal"),d=document.getElementById("hamyar-comment-form"),m=document.getElementById("show-comment-form-btn"),p=document.getElementById("comment-floating-btn"),u={currentPage:1,totalPages:1,currentFilter:"all",isLoading:!1},_=()=>{if(i){i.style.display="block";let e=i.querySelector("#product-rate-modal-rate-options");e&&(e.className="product-rate-modal-rate-options flex flex-r flex-icenter"),b(0)}},y=()=>i&&(i.style.display="none"),v="1"===m.dataset.isLoggedIn;m.dataset.loginUrl;let f=e=>{v?_():(e.preventDefault(),toast.error("برای ثبت دیدگاه باید وارد شوید."))},g=(e=!1)=>{if(u.isLoading)return;u.isLoading=!0;let l=u.currentPage>1?window.scrollY:0;n.style.display="block",o.style.display="none",1===u.currentPage&&(a.innerHTML="");let{currentPage:r,currentFilter:s}=u,c=`${hamyar_comment_data.rest_url}reviews/${t}?page=${r}&filter=${s}`;fetch(c,{headers:{"X-WP-Nonce":hamyar_comment_data.nonce}}).then(e=>e.ok?e.json():Promise.reject(e)).then(t=>{if(u.totalPages=t.pagination.total_pages,L(t.reviews,a),1===u.currentPage){let r=document.getElementById("ai-summary-wrapper");r&&(r.style.display="block")}E(t.user_status),e&&a.scrollIntoView({behavior:"smooth",block:"start"}),l>0&&window.scrollTo({top:l,behavior:"instant"}),u.currentPage<u.totalPages?o.style.display="block":o.style.display="none"}).catch(e=>{a.innerHTML=`<p class="no-comments">${hamyar_comment_data.no_comments_text||"خطایی در بارگذاری نظرات رخ داد."}</p>`,console.error("Fetch Error:",e)}).finally(()=>{n.style.display="none",u.isLoading=!1})},h=(e,t=null)=>{let l=e.author_label?`<span class="comment-label ${e.is_admin?"type-2":"type-3"}">${e.author_label}</span>`:"",r=e.approved?"":`<span class="comment-label pending">در انتظار تایید</span>`,a=e.is_admin?'<svg class="comment-tick" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 85.333c-234.667 0-426.667 192-426.667 426.667s192 426.667 426.667 426.667 426.667-192 426.667-426.667S746.667 85.333 512 85.333m-85.333 640L213.333 512l60.16-60.16 153.174 152.747 323.84-323.84 60.16 60.586-384 384z" fill="currentColor"></path></svg>':"",n=!e.is_private||e.can_reply?`
            <div class="comment-reply">
                <button class="comment-reply-btn flex" data-id="${e.id}" data-name="${e.author}">
                   <svg viewBox="0 0 32 32"><path d="M 12.28125 5.28125 L 4.28125 13.28125 L 3.59375 14 L 4.28125 14.71875 L 12.28125 22.71875 L 13.71875 21.28125 L 7.4375 15 L 21 15 C 23.773438 15 26 17.226563 26 20 C 26 22.773438 23.773438 25 21 25 L 21 27 C 24.855469 27 28 23.855469 28 20 C 28 16.144531 24.855469 13 21 13 L 7.4375 13 L 13.71875 6.71875 Z" fill="currentColor" /></svg>
                   <div class="comment-reply-tip">پاسخ به این دیدگاه</div>
                </button>
            </div>
        `:"",o="";return t&&(o=`
                <div class="comment-reply-to flex flex-r flex-icenter select-none">
                    <svg class="comment-reply-icon" viewBox="0 0 32 32"><path d="M 12.28125 5.28125 L 4.28125 13.28125 L 3.59375 14 L 4.28125 14.71875 L 12.28125 22.71875 L 13.71875 21.28125 L 7.4375 15 L 21 15 C 23.773438 15 26 17.226563 26 20 C 26 22.773438 23.773438 25 21 25 L 21 27 C 24.855469 27 28 23.855469 28 20 C 28 16.144531 24.855469 13 21 13 L 7.4375 13 L 13.71875 6.71875 Z" fill="currentColor"></path></svg>
                    <span>در پاسخ به ${t}</span>
                </div>
            `),`
            <div id="comment-${e.id}" class="comment-container flex flex-c" data-parent-id="${e.parent_id}" data-author="${e.author}" data-is-private="${e.is_private}">
                ${o}
                <div class="comment-head select-none flex flex-r flex-icenter">
                    <div class="comment-avatar flex"><img src="${e.author_avatar}">${a}</div>
                    <div class="comment-user flex flex-c">
                        <div class="comment-user-name flex flex-r flex-icenter"><span>${e.author}</span></div>
                        <div class="comment-time">${e.date}</div>
                    </div>
                    ${l}
                    ${r}
                    <div class="flex-1"></div>
                    ${n}
                </div>
                <div class="hmyt-comment-text">${e.content}</div>
            </div>
        `},L=(e,t)=>{if(0===e.length&&1===u.currentPage){a.innerHTML=`<p class="no-comments">${hamyar_comment_data.no_comments_text}</p>`;return}let l=(e,t=null)=>{let r="";return e.forEach(e=>{r+=h(e,t),e.children&&e.children.length>0&&(r+=l(e.children,e.author))}),r};e.forEach(e=>{let r=document.createElement("div");r.className="hmyt-comment-wrapper flex flex-c",r.id=`hmyt-comment-wrapper-${e.id}`;let a=h(e);e.children&&e.children.length>0&&(a+=l(e.children,e.author)),r.innerHTML=a,t.appendChild(r)})},E=e=>{let t=document.getElementById("rating-wrapper"),l=document.getElementById("product-rate-tip");if(e.can_rate?(t&&(t.style.display="block"),l&&l.classList.remove("hide")):(t&&(t.style.display="none"),l&&l.classList.add("hide")),d){let r=d.querySelector('input[name="rating"]');b(r.value)}},b=e=>{let t=document.getElementById("product-rate-modal-comment-title"),l=document.getElementById("rating-wrapper");if(!t)return;let r=l&&"none"!==l.style.display;r?(t.style.display="block",t.innerHTML=({1:"چه بد! چیکار کنیم خوشحالتون کنه؟ <small>(برامون بنویسید)</small>",2:"واقعا متاسفیم! چرا از محصول راضی نبودید؟ <small>(برامون بنویسید)</small>",3:"برای بهبود محصول چه پیشنهادی دارید؟ <small>(برای ما مهمه)</small>",4:"چطور از شما ۵ ستاره بگیریم؟ <small>(برامون بنویسید)</small>",5:"خوشحالیم که راضی بودید! <small>(درمورد نقاط قوت محصول بنویسید)</small>"})[e]||"به میزان رضایت خود میتوانید از  ۱ تا ۵ ستاره امتیاز دهید"):t.style.display="none"};if(i){let $=i.querySelector("#product-rate-modal-rate-options"),x=i.querySelectorAll(".product-rate-modal-option"),I=d.querySelector('input[name="rating"]');x.forEach(e=>{e.addEventListener("click",()=>{let t=e.dataset.value;$.className="product-rate-modal-rate-options flex flex-r flex-icenter",$.classList.add(`select-${t}`),I.value=t,b(t)})})}let w=(e,l=0)=>{let r=e.querySelector('button[type="submit"]');r.disabled=!0;let n=new FormData(e),o=n.get("content").trim();if(o.length<5){toast.error("دیدگاه شما باید حداقل شامل ۵ کاراکتر باشد."),r.disabled=!1;return}let s={product_id:t,content:n.get("content"),rating:n.get("rating")||0,parent_id:l,is_private:"true"===n.get("is_private")};fetch(`${hamyar_comment_data.rest_url}reviews/submit`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":hamyar_comment_data.nonce},body:JSON.stringify(s)}).then(e=>e.json().then(t=>({ok:e.ok,status:e.status,body:t}))).then(({ok:t,status:r,body:n})=>{if(t){e.reset(),l>0?e.closest(".reply-form-wrapper").remove():y();let o=a.querySelector(".no-comments");o&&o.remove();let s=null;if(l>0){let c=document.getElementById(`comment-${l}`);s=c.dataset.author}let i=h(n.comment,s);if(l>0){let d=document.getElementById(`hmyt-comment-wrapper-${l}`);d.insertAdjacentHTML("beforeend",i);let m=document.getElementById(`comment-${n.comment.id}`);m&&m.scrollIntoView({behavior:"smooth",block:"center"})}else{let p=document.createElement("div");p.className="hmyt-comment-wrapper flex flex-c",p.id=`hmyt-comment-wrapper-${n.comment.id}`,p.innerHTML=i,a.prepend(p),p.scrollIntoView({behavior:"smooth",block:"center"})}}else toast.error(n.message||"مشکلی در ارسال دیدگاه پیش آمد.")}).catch(e=>console.error("Submit Error:",e)).finally(()=>r.disabled=!1)};if(a.addEventListener("click",e=>{let t=e.target.closest(".comment-reply-btn");if(t){if(!v){toast.error("برای پاسخ به دیدگاه باید وارد شوید.");return}document.querySelector(".reply-form-wrapper")?.remove();let l=t.dataset.id,r=t.dataset.name,a=document.getElementById(`comment-${l}`),n="true"===a.dataset.isPrivate,o=document.createElement("div");if(o.className="reply-form-wrapper",o.innerHTML=document.getElementById("reply-form-template").innerHTML,a.after(o),n){let s=o.querySelector('input[name="is_private"]');s&&(s.checked=!0,s.disabled=!0)}o.querySelector(".reply-to-name").textContent=r,o.querySelector(".input_comment_parent_id").value=l;let c=o.querySelector("form");c.addEventListener("submit",e=>{e.preventDefault(),w(c,l)}),c.querySelector(".comment-form-reply-cancel").addEventListener("click",()=>o.remove()),o.scrollIntoView({behavior:"smooth",block:"center"})}let i=e.target.closest(".comment-reply-to");if(i){e.preventDefault();let d=i.closest(".comment-container"),m=d.dataset.parentId;if(m&&"0"!==m){let p=document.getElementById(`comment-${m}`);p&&(document.querySelectorAll(".comment-focus").forEach(e=>e.classList.remove("comment-focus")),p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("comment-focus"),setTimeout(()=>{p.classList.remove("comment-focus")},1500))}}}),m&&m.addEventListener("click",f),i&&(i.querySelector(".product-rate-modal-close").addEventListener("click",y),i.querySelector(".product-rate-modal-bg").addEventListener("click",y),d.addEventListener("submit",e=>{e.preventDefault(),w(d)})),c.forEach(e=>{e.addEventListener("click",()=>{c.forEach(e=>e.classList.remove("active")),e.classList.add("active"),u.currentFilter=e.dataset.filter,u.currentPage=1,g(!0)})}),s.addEventListener("click",()=>{u.currentPage<u.totalPages&&(u.currentPage++,g())}),p){p.classList.add("hide");let k=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?p.classList.remove("hide"):p.classList.add("hide")})},{root:null,rootMargin:"0px",threshold:0});k.observe(e),p.addEventListener("click",f)}l&&l.addEventListener("click",e=>{"product-rate-tip-close"===e.target.id||e.target.closest("#product-rate-tip-close")||_()}),r&&r.addEventListener("click",e=>{e.stopPropagation(),l&&l.classList.add("hide")}),g()});